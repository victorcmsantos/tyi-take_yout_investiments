{% extends "base.html" %}
{% block title %}Graficos | Invest Portal{% endblock %}

{% block content %}
<section class="hero">
  <h1>Graficos</h1>
  <p>Visualize a distribuicao da carteira e os principais indicadores em formato grafico.</p>
</section>

<section class="charts-grid">
  <article class="card chart-card">
    <h3>Distribuicao por tipo de ativo</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-categories"></canvas>
    </div>
  </article>

  <article class="card chart-card">
    <h3>Top 10 ativos por valor em carteira</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-top-assets"></canvas>
    </div>
  </article>

  <article class="card chart-card">
    <h3>Consolidado da carteira</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-cards"></canvas>
    </div>
  </article>

  <article class="card chart-card">
    <h3>Resultado por categoria</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-result-category"></canvas>
    </div>
  </article>

  <article class="card chart-card">
    <h3>Renda Variavel x Renda Fixa</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-classes"></canvas>
    </div>
    <p id="chart-classes-total" class="chart-total"></p>
  </article>

  <article class="card chart-card">
    <h3>Investimento Renda Fixa</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-fixed-investment"></canvas>
    </div>
  </article>

  <article class="card chart-card">
    <h3>Distribuidor Renda Fixa</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-fixed-distributor"></canvas>
    </div>
  </article>

  <article class="card chart-card">
    <h3>Emissor</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-fixed-issuer"></canvas>
    </div>
  </article>

  <article class="card chart-card">
    <h3>Proventos mes a mes (FIIs x Acoes)</h3>
    <div class="chart-canvas-wrap">
      <canvas id="chart-monthly-income"></canvas>
    </div>
  </article>
</section>

<section class="monthly-summary">
  <h2>Resumo mensal por classe</h2>
  <div class="table-wrap">
    <table class="monthly-table">
      <thead>
        <tr>
          <th rowspan="2">data</th>
          <th colspan="2">BR</th>
          <th colspan="2">FII</th>
          <th colspan="2">FIXA</th>
          <th colspan="2">Cripto</th>
          <th colspan="2">TOTAL</th>
        </tr>
        <tr>
          <th>investidos</th><th>proventos</th>
          <th>investidos</th><th>proventos</th>
          <th>investidos</th><th>proventos</th>
          <th>investidos</th><th>proventos</th>
          <th>investidos</th><th>proventos</th>
        </tr>
      </thead>
      <tbody>
        {% for row in monthly_class_summary %}
        <tr>
          <td>{{ row.label }}</td>
          <td>R$ {{ '%.2f'|format(row.br_invested) }}</td><td>R$ {{ '%.2f'|format(row.br_incomes) }}</td>
          <td>R$ {{ '%.2f'|format(row.fii_invested) }}</td><td>R$ {{ '%.2f'|format(row.fii_incomes) }}</td>
          <td>R$ {{ '%.2f'|format(row.fixa_invested) }}</td><td>R$ {{ '%.2f'|format(row.fixa_incomes) }}</td>
          <td>R$ {{ '%.2f'|format(row.cripto_invested) }}</td><td>R$ {{ '%.2f'|format(row.cripto_incomes) }}</td>
          <td><strong>R$ {{ '%.2f'|format(row.total_invested) }}</strong></td><td><strong>R$ {{ '%.2f'|format(row.total_incomes) }}</strong></td>
        </tr>
        {% endfor %}
        {% if not monthly_class_summary %}
        <tr>
          <td colspan="11">Sem dados mensais para o periodo selecionado.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<section class="monthly-summary">
  <h2>Investidos por mes (ano)</h2>
  <div class="table-wrap">
    <table class="annual-month-table">
      <thead>
        <tr>
          <th></th>
          {% for year in annual_invested_summary.years %}
          <th>{{ year['label'] }} - R${{ '%.2f'|format(year['total']) }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for month_label in annual_invested_summary.months %}
        {% set month_idx = loop.index0 %}
        <tr>
          <th>{{ month_label }}</th>
          {% for year in annual_invested_summary.years %}
          <td>R$ {{ '%.2f'|format(year['values'][month_idx]) }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
        {% if not annual_invested_summary.years %}
        <tr>
          <td colspan="2">Sem dados para tabela anual.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  const brl = (value) => `R$ ${Number(value || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const brlCompact = (value) => `R$ ${Number(value || 0).toLocaleString("pt-BR", { notation: "compact", maximumFractionDigits: 2 })}`;

  const baseTooltip = {
    plugins: {
      tooltip: {
        callbacks: {
          label: (ctx) => `${ctx.dataset.label || ""} ${brl(ctx.raw)}`.trim()
        }
      },
      legend: {
        labels: { boxWidth: 12, usePointStyle: true }
      }
    }
  };

  const categoryData = {{ category_chart|tojson }};
  const topAssetsData = {{ top_assets_chart|tojson }};
  const cardsData = {{ cards_chart|tojson }};
  const resultByCategoryData = {{ result_by_category_chart|tojson }};
  const classesData = {{ classes_chart|tojson }};
  const fixedInvestmentData = {{ fixed_income_investment_chart|tojson }};
  const fixedDistributorData = {{ fixed_income_distributor_chart|tojson }};
  const fixedIssuerData = {{ fixed_income_issuer_chart|tojson }};
  const monthlyIncomeData = {{ monthly_income_chart|tojson }};

  Chart.register(ChartDataLabels);

  if (categoryData.values.length > 0) {
    new Chart(document.getElementById("chart-categories"), {
      type: "doughnut",
      data: {
        labels: categoryData.labels,
        datasets: [{
          label: "Valor",
          data: categoryData.values,
          backgroundColor: ["#0f7b6c", "#2d6cdf", "#ea8a2f", "#6f42c1"],
          borderWidth: 1
        }]
      },
      options: {
        ...baseTooltip,
        plugins: {
          ...baseTooltip.plugins,
          datalabels: { display: false }
        },
        maintainAspectRatio: false
      }
    });
  }

  if (topAssetsData.values.length > 0) {
    new Chart(document.getElementById("chart-top-assets"), {
      type: "bar",
      data: {
        labels: topAssetsData.labels,
        datasets: [{
          label: "Valor",
          data: topAssetsData.values,
          backgroundColor: "#2d6cdf"
        }]
      },
      options: {
        ...baseTooltip,
        plugins: {
          ...baseTooltip.plugins,
          datalabels: { display: false }
        },
        maintainAspectRatio: false,
        scales: {
          y: {
            ticks: {
              callback: (value) => brl(value)
            }
          }
        }
      }
    });
  }

  new Chart(document.getElementById("chart-cards"), {
    type: "bar",
    data: {
      labels: cardsData.labels,
      datasets: [{
        label: "Valor",
        data: cardsData.values,
        backgroundColor: ["#0f7b6c", "#2d6cdf", "#f2a93b"]
      }]
    },
    options: {
      ...baseTooltip,
      plugins: {
        ...baseTooltip.plugins,
        datalabels: {
          color: "#ffffff",
          anchor: "center",
          align: "center",
          formatter: (value) => brlCompact(value),
          font: { weight: "700", size: 11 }
        }
      },
      maintainAspectRatio: false,
      scales: {
        y: {
          ticks: {
            callback: (value) => brl(value)
          }
        }
      }
    }
  });

  const resultColors = resultByCategoryData.values.map((value) => value >= 0 ? "#3f7edb" : "#d74a4a");
  new Chart(document.getElementById("chart-result-category"), {
    type: "bar",
    data: {
      labels: resultByCategoryData.labels,
      datasets: [{
        label: "Resultado",
        data: resultByCategoryData.values,
        backgroundColor: resultColors,
        borderWidth: 1
      }]
    },
    options: {
      ...baseTooltip,
      maintainAspectRatio: false,
      plugins: {
        ...baseTooltip.plugins,
        datalabels: {
          color: (ctx) => (ctx.raw >= 0 ? "#255eb5" : "#b63838"),
          anchor: (ctx) => (ctx.raw >= 0 ? "end" : "start"),
          align: (ctx) => (ctx.raw >= 0 ? "end" : "start"),
          offset: 4,
          formatter: (value) => brlCompact(value),
          font: { weight: "700", size: 11 }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: (value) => brl(value)
          },
          grid: {
            color: (ctx) => (ctx.tick && ctx.tick.value === 0 ? "#5a5a5a" : "#e1e6ec"),
            lineWidth: (ctx) => (ctx.tick && ctx.tick.value === 0 ? 1.6 : 1),
          }
        }
      }
    }
  });

  new Chart(document.getElementById("chart-classes"), {
    type: "pie",
    data: {
      labels: classesData.labels,
      datasets: [{
        label: "Valor",
        data: classesData.values,
        backgroundColor: ["#2d6cdf", "#0f7b6c"],
        borderWidth: 1
      }]
    },
    options: {
      ...baseTooltip,
      plugins: {
        ...baseTooltip.plugins,
        datalabels: {
          color: "#ffffff",
          anchor: "center",
          align: "center",
          formatter: (value) => brlCompact(value),
          font: { weight: "700", size: 11 }
        }
      },
      maintainAspectRatio: false
    }
  });
  const classesTotal = classesData.values.reduce((acc, value) => acc + Number(value || 0), 0);
  const classesTotalEl = document.getElementById("chart-classes-total");
  if (classesTotalEl) {
    classesTotalEl.textContent = `Soma: ${brl(classesTotal)}`;
  }

  if (fixedInvestmentData.values.length > 0) {
    new Chart(document.getElementById("chart-fixed-investment"), {
      type: "bar",
      data: {
        labels: fixedInvestmentData.labels,
        datasets: [{
          label: "Valor aplicado",
          data: fixedInvestmentData.values,
          backgroundColor: "#4b80db"
        }]
      },
      options: {
        ...baseTooltip,
        plugins: {
          ...baseTooltip.plugins,
          datalabels: {
            color: "#255eb5",
            anchor: "end",
            align: "end",
            offset: 4,
            formatter: (value) => brlCompact(value),
            font: { weight: "700", size: 11 }
          }
        },
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxRotation: 0,
              autoSkip: false
            }
          },
          y: {
            ticks: {
              callback: (value) => brl(value)
            }
          }
        }
      }
    });
  }

  if (fixedDistributorData.values.length > 0) {
    new Chart(document.getElementById("chart-fixed-distributor"), {
      type: "bar",
      data: {
        labels: fixedDistributorData.labels,
        datasets: [{
          label: "Valor aplicado",
          data: fixedDistributorData.values,
          backgroundColor: "#4b80db"
        }]
      },
      options: {
        ...baseTooltip,
        plugins: {
          ...baseTooltip.plugins,
          datalabels: {
            color: "#255eb5",
            anchor: "end",
            align: "end",
            offset: 4,
            formatter: (value) => brlCompact(value),
            font: { weight: "700", size: 11 }
          }
        },
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxRotation: 0,
              autoSkip: false
            }
          },
          y: {
            ticks: {
              callback: (value) => brl(value)
            }
          }
        }
      }
    });
  }

  if (fixedIssuerData.labels.length > 0) {
    new Chart(document.getElementById("chart-fixed-issuer"), {
      type: "bar",
      data: {
        labels: fixedIssuerData.labels,
        datasets: [
          {
            label: "investimento",
            data: fixedIssuerData.investment_values,
            backgroundColor: "#2f67cb"
          },
          {
            label: "rendimento",
            data: fixedIssuerData.income_values,
            backgroundColor: "#3f8a2f"
          }
        ]
      },
      options: {
        ...baseTooltip,
        plugins: {
          ...baseTooltip.plugins,
          datalabels: {
            color: (ctx) => (ctx.datasetIndex === 0 ? "#255eb5" : "#2e6a22"),
            anchor: "end",
            align: "end",
            offset: 2,
            formatter: (value) => value === 0 ? "" : brlCompact(value),
            font: { weight: "700", size: 10 }
          }
        },
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              autoSkip: false
            }
          },
          y: {
            ticks: {
              callback: (value) => brl(value)
            }
          }
        }
      }
    });
  }

  if (monthlyIncomeData.labels.length > 0) {
    new Chart(document.getElementById("chart-monthly-income"), {
      type: "line",
      data: {
        labels: monthlyIncomeData.labels,
        datasets: [
          {
            label: "FIIs",
            data: monthlyIncomeData.fii_values,
            borderColor: "#0f7b6c",
            backgroundColor: "rgba(15, 123, 108, 0.15)",
            pointBackgroundColor: "#0f7b6c",
            tension: 0.25,
            fill: false,
          },
          {
            label: "Acoes",
            data: monthlyIncomeData.acoes_values,
            borderColor: "#2d6cdf",
            backgroundColor: "rgba(45, 108, 223, 0.15)",
            pointBackgroundColor: "#2d6cdf",
            tension: 0.25,
            fill: false,
          }
        ]
      },
      options: {
        ...baseTooltip,
        plugins: {
          ...baseTooltip.plugins,
          datalabels: { display: false }
        },
        maintainAspectRatio: false,
        scales: {
          y: {
            ticks: {
              callback: (value) => brl(value)
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
