{% extends "base.html" %}
{% block title %}Renda Fixa | Invest Portal{% endblock %}

{% block content %}
{% macro sort_link(label, field, sort_by, sort_dir, selected_portfolio_ids, anchor='rf-table') -%}
<a href="{{ url_for('main.renda_fixa', portfolio_id=selected_portfolio_ids, sort_by=field, sort_dir='asc' if sort_by != field or sort_dir == 'desc' else 'desc') }}#{{ anchor }}">{{ label }}{% if sort_by == field %} {{ '↑' if sort_dir == 'asc' else '↓' }}{% endif %}</a>
{%- endmacro %}
<div class="fixed-income-wide">
<section class="hero">
  <h1>Renda Fixa</h1>
  <p>Acompanhe valor aplicado, valor atual estimado e rendimento dos seus titulos.</p>
  <p><a href="{{ url_for('main.nova_transacao', portfolio_id=selected_portfolio_ids) }}#renda-fixa-form">Novo cadastro de renda fixa</a></p>
  {% if error %}
  <p class="alert-error">{{ error }}</p>
  {% endif %}
  {% if remove_message %}
  <p class="alert-success">{{ remove_message }}</p>
  {% endif %}
</section>

<section class="grid grid-4">
  <article class="card">
    <h3>Total aplicado</h3>
    <p class="highlight">R$ {{ '%.2f'|format(summary.applied_total) }}</p>
  </article>
  <article class="card">
    <h3>Valor atual estimado</h3>
    <p class="highlight">R$ {{ '%.2f'|format(summary.current_total) }}</p>
  </article>
  <article class="card">
    <h3>Rendimento estimado</h3>
    <p class="highlight {{ 'up' if summary.income_total >= 0 else 'down' }}">
      R$ {{ '%.2f'|format(summary.income_total) }}
    </p>
  </article>
  <article class="card">
    <h3>Valor final estimado</h3>
    <p class="highlight">R$ {{ '%.2f'|format(summary.final_total) }}</p>
  </article>
  <article class="card">
    <h3>Total recebido</h3>
    <p class="highlight">R$ {{ '%.2f'|format(summary.total_received) }}</p>
  </article>
  <article class="card">
    <h3>Rendimento Recebido</h3>
    <p class="highlight {{ 'up' if summary.rendimento_recebido_total >= 0 else 'down' }}">
      R$ {{ '%.2f'|format(summary.rendimento_recebido_total) }}
    </p>
  </article>
</section>

<form method="post" action="{{ url_for('main.remover_renda_fixa') }}">
  {% for pid in selected_portfolio_ids %}
  <input type="hidden" name="portfolio_id" value="{{ pid }}">
  {% endfor %}
  <section class="asset-accordion-wrap">
    {% for group in fixed_income_groups %}
    <details class="asset-group" id="rf-{{ group['key'] }}" {% if loop.first %}open{% endif %}>
      <summary class="asset-group-summary">
        <div class="asset-group-title">
          <h2>{{ group['title'] }}</h2>
          <p>{{ group['summary']['count'] }} registro(s)</p>
        </div>
        <div class="asset-group-metrics">
          {% set carteira_total = summary.current_total|float %}
          {% set grupo_total = group['summary']['current_total']|float %}
          {% set grupo_peso = (grupo_total / carteira_total * 100) if carteira_total > 0 else 0 %}
          <div>
            <span>Aplicado</span>
            <strong>R$ {{ '%.2f'|format(group['summary']['applied_total']) }}</strong>
          </div>
          <div>
            <span>Valor atual</span>
            <strong>R$ {{ '%.2f'|format(group['summary']['current_total']) }}</strong>
          </div>
          <div>
            <span>Rendimento estimado</span>
            <strong class="{{ 'up' if group['summary']['income_total'] >= 0 else 'down' }}">R$ {{ '%.2f'|format(group['summary']['income_total']) }}</strong>
          </div>
          <div>
            <span>Rendimento recebido</span>
            <strong class="{{ 'up' if group['summary']['rendimento_recebido_total'] >= 0 else 'down' }}">R$ {{ '%.2f'|format(group['summary']['rendimento_recebido_total']) }}</strong>
          </div>
          <div>
            <span>% na carteira</span>
            <strong>{{ '%.2f'|format(grupo_peso) }}%</strong>
          </div>
        </div>
        <span class="asset-group-chevron"></span>
      </summary>
      <div class="asset-group-body">
        <section class="table-wrap" id="rf-table-{{ group['key'] }}">
          <table>
            <thead>
              <tr>
                <th>Sel.</th>
                <th>{{ sort_link('Carteira', 'portfolio_name', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Distribuidor', 'distributor', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Emissor', 'issuer', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Investimento', 'investment_type', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Taxa', 'annual_rate', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Data aporte', 'date_aporte', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Data final', 'maturity_date', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Aplicado', 'active_applied_value', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Dias', 'elapsed_days', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Total dias', 'total_days', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Valor atual', 'current_gross_value', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Total recebido', 'total_received', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Rendimento Recebido', 'rendimento', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
                <th>{{ sort_link('Valor final', 'final_gross_value', sort_by, sort_dir, selected_portfolio_ids, 'rf-' ~ group['key']) }}</th>
              </tr>
            </thead>
            <tbody>
              {% for item in group['items'] %}
              <tr>
                <td><input type="checkbox" name="fixed_income_ids" value="{{ item.id }}"></td>
                <td>{{ item.portfolio_name }}</td>
                <td>{{ item.distributor }}</td>
                <td>{{ item.issuer }}</td>
                <td>{{ item.investment_type }}</td>
                <td>{{ item.rate_type }} {{ '%.2f'|format(item.annual_rate) }}%</td>
                <td>{{ item.date_aporte | date_br }}</td>
                <td>{{ item.maturity_date | date_br }}</td>
                <td>R$ {{ '%.2f'|format(item.active_applied_value) }}</td>
                <td>{{ item.elapsed_days }}</td>
                <td>{{ item.total_days }}</td>
                <td>R$ {{ '%.2f'|format(item.current_gross_value) }}</td>
                <td>R$ {{ '%.2f'|format(item.total_received) }}</td>
                <td class="{{ 'up' if item.rendimento >= 0 else 'down' }}">R$ {{ '%.2f'|format(item.rendimento) }}</td>
                <td>R$ {{ '%.2f'|format(item.final_gross_value) }}</td>
              </tr>
              {% endfor %}
              {% if not group['items'] %}
              <tr>
                <td colspan="15">Nenhum investimento nessa categoria.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </section>
      </div>
    </details>
    {% endfor %}
  </section>
  <div class="table-actions">
    <button type="submit" class="btn-danger">Remover selecionados</button>
  </div>
</form>
</div>
{% endblock %}
